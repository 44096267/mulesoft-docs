= Connecting ARM to Splunk Tutorial
keywords: analytics, monitoring, splunk, mule events, logging, api analytics, metrics, traceability, arm, anypoint runtime manager

The objective of this demo is to show different alternatives to the use for how business events (phase #1) and api analytics (phase #2) can be consumed when using on premise installations.

In order to provide a real life demo, we reused the APILed Workshop Order Tracking application which is an RAML based API for creating order to buy products that also contains an API proxy on top that we will use in Phase #2 to extract analytics.

The following diagram is an overview on the entire API Led Demo:

image:arm_tutorial_big_picture.png[ARM Tutorial Big Picture]

== API Led Demo Summary

This demo shows an order system following an API Led approach. This system is modeled to allow a user to create orders using a mobile application (or emulator) and query the status of previously created orders.
When creating an order, the user needs to complete a form and, depending on the values of those fields, different business flows are called.
The most important field among these is the country:

* *country = United States* implies that once the order is placed, a message in a queue is created for all the listeners to consume it.
* *country = Other* implies that the order is merely logged.

Below is the demo main flow.

image:arm_tutorial_full_flow.png[full flow]

The main objective of this demo is to show how Business Events – both default and custom events – can be monitored and consumed using Splunk. We therefore slightly modified the demo in order to create business events when:
* a new order is placed
** if the country is `United States`, another additional event gets created, confirming that the message was put into the queue.
* an existing order is queried to get the status

== Environment Configuration

Since we will be using an on premise ESB, we created an Windows AWS instance to the ESB where the demo application is running.
* *For Splunk*, we are using an instance provided to us by engineering.
* *For ARM* we are using a Staging version since the release it's not out yet.

All the information about hosts and users is listed below:

* *AWS Instance*
** host: 54.209.14.145:443
** user: msps
** pass: Anypoint1357!
* *Staging ARM*
** host: https://stg.anypoint.mulesoft.com/
** user: arm-demo
** pass: Mule1379
* *Splunk instance*
** host: https://ec2-52-88-188-182.us-west-2.compute.amazonaws.com
** user: admin
** pass: Muleftw1!

== How to Run the Demo

This demo can be used to show that a user can integrate their onprem systems (like Splunk, ELK or any other third party systems) to consume information produced by Mule such as Business Events, API analytics, logs, etc.

Depending on what you want to position is how you should run the demo. The demo consists on:

. Running the business use case
. Running the integration section
.. Business events: show business events integration with Splunk
.. Analytics: show API analytics events integration with Splunk.
. Running the agent configuration section.


=== Running the business use case

. Connect to the AWS instance using Remote Desktop
+
image:arm_demo_remote_desktop.png[remote desktop]

. Open the iPhone Simulator on using the link on the Desktop, scroll to the bottom and select ‘Create an order'.

+
image:arm_tutorial_emulator.png[emulator]

. Enter the required values:
.. first and and last name
.. address: must contain at least 10 characters and a number.
.. email: should be your email in order to get notified
.. products: chose any products
.. country: choose united states
+
image:arm_tutorial_emulator_form.png[emulator]

. Scroll down and create the order. When the order gets created, a business event containing the *order id* and the *count* gets generated and pushed to Splunk.
. Click on the order you just created in order to check the order status. Once again, a business events gets created and pushed to Splunk.
. This concludes the business use case.

== Business Events Integration

. Now let's go to Splunk and see the business events. We created a report to show both default business events per integration flow and custom business events generated by the user.
.. You can see the actual report in Splunk through link:http://ec2-52-88-188-182.us-west-2.compute.amazonaws.com/en-US/app/search/demo__business_events_dashboard?earliest=0&latest=[this url]. The report looks like this:
+
image:arm_tutorial_activity.png[activity]
. If you click on any of the events, you can see all of the information linked to it. Below are two examples:
+
image:arm_tutorial_event1.png[event]
+
image:arm_tutorial_event2.png[event]

. Keep in mind that this is just a sample of all the information that we can push to Splunk. Other useful information, like server metrics, could be imported as well by using link:http://blogs.mulesoft.com/dev/mule-dev/intro-mule-agent-architecture/[other internal handlers] such as JMX.

== Gateway Analytics Integration

== Agent Configuration

An important part of this demo, is to show how the integration must be setup. All that needs to be done to achieve this is to configure the link:/mule-agent/v/1.2.0/index[The Mule Agent] to use the Splunk Internal Handler to push information into Splunk.
The handler configuration for both Business Events or Analytics, can be configured through the ARM UI. Here are the steps to do this:

. Let's login to ARM using the provided credentials.
. Click on the Servers tab to see all the servers – both with ESB and API Gateway runtimes – currently managed by ARM
. For purposes of the demo, let's use the gateway as the server where we will show the agent configuration. Click on the `arm-demo-gateway` server, the server details page will then display on the right:
+
image:arm_ui_activate_agent.png[agent]
. There are two tabs on this menu: Applications and Agent Plugins. Click on Agent Plugins and to see the following configuration:
+
image:arm_ui_splunk_api.png[agent]

. From this menu, we can configure all of the plugins for the agent. Once we make a change, ARM will update your local instance of API Gateway (or ESB) using the Agent Rest API.
. Let’s click on the Splunk Plugin to see its configuration parameters.
+
[TIP]
We could also configure ELK in the same way that we configured Splunk in this tutorial.

. Once we click on the configuration button, we can modify any of the parameters on the Splunk plugin, like: user credentials, indexes, etc.
+
image:arm_ui_configure_splunk.png[agent]
.We can also manage the agent configuration at a cluster level, this configuration would then be replicated automatically to all of its nodes.

[NOTE]
====
While setting the agent configuration via the ARM UI, this simply composes a YAML file like the one shown below:

[source,yaml,linenums]
----
transports:
  rest.agent.transport:
	enabled: true
	port: 9997
services:
  mule.agent.tracking.service:
	globalTrackingLevel: DEBUG
internalHandlers:
  domaindeploymentnotification.internal.message.handler:
	enabled: true
  applicationdeploymentnotification.internal.message.handler:
	enabled: true
  mule.agent.tracking.handler.log:
	enabled: true
	fileName: /var/log/mule/agent/mule-event-tracking.log
	filePattern: /var/log/mule/agent/mule-event-tracking-%d{yyyy-dd-MM}-%i.log
  mule.agent.tracking.handler.splunk:
	enabled: 'true'
	scheme: https
	host: ec2-52-88-188-182.us-west-2.compute.amazonaws.com
	user: xxx
	pass: xxxx
	splunkSource: mule-event-tracking-demo
----

====
