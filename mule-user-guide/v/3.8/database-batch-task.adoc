= To Batch Write to a File

In this procedure, a database connector retrieves data from two tables. Mule feeds this data into the DataWeave transformer inside the Batch Commit. DataWeave maps this data to the CSV format. A file connector writes the resulting CSV file to disk, and a logger component logs processing details to the console. 

This procedure uses a MySQL sample database, which you can import. Download this script using the following URL:

`+https://docs.mulesoft.com/mule-user-guide/v/3.8/_attachments/create.sample.db.sql+`

The script creates the database that has tables named employees and roles. 

. In Studio, create a new project. Drag a Poll, Database, Batch_Step, Batch Commit, Transform, File, and Logger connector to the canvas as follows:
+
* Put the Database connector inside the Poll in the _input_ section.
* Put the Batch Commit inside the Batch Step.
* Put the Transform and File inside the Batch Commit in the _process_ section of Batch Step.
* Put the Logger in the _on complete_ section of Batch Step, as shown in the following screenshot:
+
image::database-connector-examples-bf9df.png[batch task components]
+
. In Database properties, click image:Add-16x16.png[add], and set the following options:
* Host: The name of the host running MySQL.
* Port: *3306*
* User and Password: Your database user name and password.
* Database: *company*
* MySQL Driver: Browse to and select the driver on your file system that is compatible with your database.
+
Test and save the settings.
+
. In Database properties, set options according to the following table:
+
[%header%autowidth.spread]
|===
|Parameter |Value
|*Operation* |`Select`
|*Query Type* |`Parameterized`
|*Parameterized SQL Statement* |`SELECT no, first_name, last_name, role FROM employees INNER JOIN roles ON employees.no = roles.emp_no;`
|===
+
. Double-click Transform Message to open its configuration.
+
Datasense should build the input side of your transform. If this is not the case, define the metadata as *Map*, comprised of *List<Element>*, adding the attributes and their types per the database table attributes. To instruct DataWeave how to process the MySQL data, right click the words "Payload" on the left side of the pane and click *Set Metadata*.
+
image:database-connector-examples-ab246.png[set metadata]
+
image:database-connector-examples-871e9.png[ex2.dataweave.conn.select]
+
The DataWeave transformer configuration appears as follows.
+
image:database-connector-examples-72b35.png[ex2.finished.dataweave]
+
The resulting DataWeave code is auto-generated, and appears like this:
+
[source,code,linenums]
----
%dw 1.0
%output application/csv
---
payload map ((payload01 , indexOfPayload01) -> {
	column_0: payload01.first_name,
	column_1: payload01.last_name,
	column_2: payload01.no,
	column_3: payload01.role
})
----
+
. Configure the file connector to save the CSV file to your file system.
. Configure the Logger to output the message displayed below, at log level `WARN`.
+
[source, code, linenums]
----
Total Records exported: #[message.payload.getLoadedRecords()], Failed Records: #[message.payload.getFailedRecords()], Processing time: #[message.payload.getElapsedTimeInMillis()]
----
. Run the app, check that the results appear in the file on your file system, check the logged messages, and stop the app from running every ten minutes.

== See Also

* link:attachments/batch-example.txt[Download XML code for this example]
* link:/mule-user-guide/v/3.8/batch-processing[batch processing]
* link:/mule-user-guide/v/3.8/poll-reference[poll scope]
