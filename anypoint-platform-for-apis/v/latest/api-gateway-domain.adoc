= API Gateway Domain
:keywords: api, gateway, domain

The domain named *api-gateway* included in API Gateway 2.0.n - 2.2.n has been removed in API Gateway 3.8.0. If you want to continue using the API Gateway domain after upgrading from API Gateway 2.x to API Gateway 3.8.0, run the gateway_domain_setup script in the `bin` directory of the Mule 3.8.0 distribution before deploying a proxy. Alternatively, copy the domain from your old release to the new one. API Manager supports generating a proxy for referencing the domain. 

== Internal Configuration

The domain defines two listener configurations named
*http-lc-0.0.0.0-8081* and *https-lc-0.0.0.0-8082*.

* *http-lc-0.0.0.0-8081*, as its name indicates, binds to all interfaces and uses port 8081, which is the default port for HTTP in Cloudhub.
+
Example:
+
[source,xml]
----
<http:listener-config name="http-lc-0.0.0.0-8081" host="0.0.0.0" port="8081" protocol="HTTP"/>
----
+
[CAUTION]
This means that the API Gateway runtime reserves port 8081 when it starts. If you are already using that port, a message appears saying that the port is already in use, and all auto-generated proxies will fail.
+
* *https-lc-0.0.0.0-8082*, which is commented out, is the listener configuration for HTTPS. To use this, follow the different steps depending on the runtime you are running. Check the following sections for more details.

== Implications of Auto-Generated proxies

All auto-generated proxies already have a reference to the domain.
With this configuration, if you are using HTTP, you can use the auto-deploy feature to run your proxies in any runtime (Standalone, Hybrid, Cloudhub) without modifications. If you are using HTTPS, go to the following section for more details.

== Using API Gateway Domain

If you use Anypoint Studio 5.3 - 5.4, you can configure your application to reference the API Gateway Domain listener. 

After installing and configuring API Gateway, you can reference the listener from the `mule-domain-config.xml` in the domain project in your application/proxy HTTP listener configuration. If you use port 8081 in a standalone, hybrid, or Studio application, reference the following http or https name of the listener-config provided in `mule-domain-config.xml` in your application/proxy:

* http-lc-0.0.0.0-8081
* https-lc-0.0.0.0-8082

For example, your HTTP listener configuration in the application/proxy is originally configured as follows:

`<http:listener config-ref="HTTP_Listener_Configuration" path="/api/*" doc:name="HTTP"/>`

To reference the http name provided by the domain, change the HTTP listener configuration as follows:

`<http:listener config-ref="http-lc-0.0.0.0-8081" path="/api/*" doc:name="HTTP"/>`

== Avoiding Port Conflicts

To successfully register an API on the Anypoint Platform for APIs, you must deploy the API (or its proxy) to the API Gateway using a unique endpoint URL. This means that no other APIs that your organization deploys to the gateway can have the same endpoint, which can become a problem if you need to deploy more than one automatically generated proxy to the same server. Automatically generated proxies use the the path `http://0.0.0.0:8081`, and thus deploying more than one of them without modification to an API Gateway (whether the same instance or multiple) on the same machine causes a port conflict.

Servers try to expose every interface, privileging the most declarative ones. For example `local_ip` is privileged against `localhost`.

If you are using the link:/anypoint-platform-for-apis/api-auto-discovery[API auto-discovery] feature, your endpoint auto registers using the local IP address. Note that if your IP changes, update your endpoint accordingly.


To avoid port conflicts, ensure that whenever automatically generated proxies need to be deployed to the same machine, they use different ports. In the case of automatically generated proxies, this means that you need to link:/anypoint-platform-for-apis/proxying-your-api[manually modify the proxy files] to change the proxy endpoint to use a different port.

== Deploying with Shared Resources

Some organizations may wish to consistently use standard ports for exposing their APIs. To achieve this, implement the link:/mule-user-guide/v/3.7/shared-resources[shared resources] feature. Configuring shared resources allows your APIs to deploy side by side on the same API Gateway, sharing a common port. The domain configuration only needs to specify the shared HTTP(S) connector to which the multiple HTTP listener endpoints should reference. You can also configure this in the same way on automatically generated proxies by modifying the HTTP Listener accordingly. For example, you can configure your domain as follows:

[source,xml,linenums]
----
<?xml version="1.0" encoding="UTF-8"?>
<mule-domain xmlns="http://www.mulesoft.org/schema/mule/ee/domain"
             xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             xmlns:http="http://www.mulesoft.org/schema/mule/http"
             xmlns:tls="http://www.mulesoft.org/schema/mule/tls"
             xsi:schemaLocation="http://www.mulesoft.org/schema/mule/ee/domain http://www.mulesoft.org/schema/mule/ee/domain/current/mule-domain-ee.xsd
                                 http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd
                                 http://www.mulesoft.org/schema/mule/tls http://www.mulesoft.org/schema/mule/tls/current/mule-tls.xsd">


    <http:listener-config name="http-lc-0.0.0.0-8081" host="0.0.0.0" port="8081" protocol="HTTP"/>


</mule-domain>
----


The HTTP Listener endpoint of each proxy might then look like this:

[source,xml,linenums]
----
       <http:listener config-ref="http-lc-0.0.0.0-8081" path="gateway/rest/basicauth/path1/*" doc:name="HTTP"/>
----

The domain configuration should be saved as `mule-domain-config.xml` in `/domains/default`.


[[cloudhubsection]]
=== Cloudhub

The features for deploying an app to CloudHub might not be visible or accessible to you, depending on link:/release-notes/anypoint-platform-for-apis-release-notes[entitlements you purchased].

If you want to create a new app and deploy it to Cloudhub, take into account that:

* To create an app which uses an HTTP configuration, you need to reference the listener-config named *http-lc-0.0.0.0-8081*.
* Otherwise, if your app uses HTTPS, the listener-config configuration must be placed inside of your configuration. This means that you should include the following piece of code in your proxy/app xml file and provide your credentials when necessary:

[source,xml,linenums]
----
<http:listener-config name="https-lc-0.0.0.0-8082" host="0.0.0.0" port="8082" protocol="HTTPS">
  <tls:context name="tls-context-config">
    <tls:key-store path="[replace_with_path_to_keystore_file]" password="[replace_with_store_password]"
        keyPassword="[replace_with_key_password]"/>
  </tls:context>
</http:listener-config>
----

After including this `listener-config`, add a reference to it in your listener.

=== Standalone and Hybrid

If you want to create a new app and deploy it in a standalone version, you can take advantage of the api-gateway domain by referencing the HTTP or HTTPS listener-configs in your listeners and sharing the port configuration.

[TIP]
If your proxy/app uses HTTPS, reference the `listener-config` named *https-lc-0.0.0.0-8082*, uncomment it from the domain (located in './domains/api-gateway/mule-domain-config.xml'), and add the necessary credentials.

== Anypoint Studio Support

Anypoint Studio from version 5.3-5.4 and newer provides support for the Gateway domain:

. Click *Help* > *Add New Software*.
. In *Work with*, click *API Gateway Site*, click *API Gateway Tooling Runtimes*, and check *API Gateway Runtime 2.0.3* or newer.
. Follow the prompts to install the software.
. For a new project, click the API Gateway version:
+
image:api-gateway-new-project.png[api-gateway-new-project]

When creating or importing a project,
if the runtime is a Gateway distribution with version 2.0.2 or newer,
the `api-gateway` domain is created. This domain appears in the Package Explorer view as a regular application.
If the domain is not created, Studio provides the option to do so by right-clicking the application in the Package Explorer
and selecting *Domains* > *Associate with API Gateway domain*:

image:api-gateway-associate-domain.png[api-gateway-associate-domain]

You can check that this domain is associated to your project by
viewing the mule-project.xml file of your project.

image:api-gateway-mule-project.png[api-gateway-mule-project]

This domain project is identical to the domain that exists in Cloudhub and in your API Gateway On Premises by default. It’s necessary for being able to deploy your app to the Anypoint Studio server under the same conditions as when deployed to production.

[CAUTION]
If you modify your domain on your API Gateway on-prem installation, you should also replicate those changes in the domain that exists in Studio so that you can deploy it under the same conditions in both places. The Domain project contains the `<http:listener-config` statement that the Mule flow requires. If you make any changes to your domain, these modifications are not reflected in Cloudhub.

== Q & A

*Can I use my own listener-config in my app/proxy?*

If you are using the standalone, hybrid, or Studio: Yes, as long as you are not using the port 8081.
In that case, we recommend that you reference the `listener-config` provided in the domain,
or you will receive the error message `Address already in use`.
If you are using Cloudhub: see the xref:cloudhubsection[Cloudhub] section.

*When I test my app I see the "Address already in use" error. How can I get rid of that issue?*

This error message displays for several reasons:

 - If your app is already using listener-config references.

 - If you are using a hybrid/standalone version and you have multiple apps, check that their paths are not duplicated.

 - Check if the port 8081 is not bound to another application/program. In that case you can locally modify the port of the listener-config by changing the domain config in `./domains/api-gateway/mule-domain-config.xml`

== See Also

* link:http://training.mulesoft.com[MuleSoft Training]
* link:https://www.mulesoft.com/webinars[MuleSoft Webinars]
* link:http://blogs.mulesoft.com[MuleSoft Blogs]
* link:http://forums.mulesoft.com[MuleSoft's Forums]
* link:https://www.mulesoft.com/support-and-services/mule-esb-support-license-subscription[MuleSoft Support]
* mailto:support@mulesoft.com[Contact MuleSoft]
