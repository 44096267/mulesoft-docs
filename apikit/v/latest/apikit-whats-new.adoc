= What's New in APIkit

If you're an APIkit 3.x user, you can get up and running quickly with APIkit 4 Beta quickly--basic use hasn't changed. Key changes and improvements in APIkit are:

* APIkit is now a Mule plugin.
* API Console V4, which you use to simulate calls to the API, is not embedded in Studio.
* Configuring APIkit and the Mule project structure has changed.
* Error handling is aligned with Mule 4.0.

== APIkit Distribution

As a Mule plugin, you can update APIkit in a straightforward manner. The timing of future improvements and fixes are no longer constrained by Studio or Mule release schedules.

In order to use APIkit, add the following dependency to the POM of your application.

[source,xml,linenums]
----
<dependency>
    <groupId>org.mule.modules</groupId>
    <artifactId>mule-apikit-module</artifactId>
    <version>version</version>
    <classifier>mule-plugin</classifier>
</dependency>
----

== Handling Errors

APIkit 4.0 replaces exception strategy and error mapping with the Mule 4 error handler. This error handler uses error types:

[source,xml,linenums]
----
<apikit:router config-ref="api-config" />
<error-handler>
    <on-error-propagate type="APIKIT:BAD_REQUEST">
        <ee:transform xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd">
            <ee:message>
                <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{message: "Bad request"}]]></ee:set-payload>
            </ee:message>
            <ee:variables>
                <ee:set-variable variableName="httpStatus">400</ee:set-variable>
            </ee:variables>
        </ee:transform>
    </on-error-propagate>
</error-handler>    
----

Each error response is generated using DataWeave.

== Customizing the API Console URL

In API Console V4, you can customize the url for exposing the API.

By default, the console is exposed in `/console`. 

[source,xml,linenums]
----
<flow name="main-console">
    <http:listener config-ref="httpListenerConfigDefault" path="/console/*">
        <http:response statusCode="#[variables.httpStatus default 200]">
            <http:headers>#[variables.outboundHeaders default {}]</http:headers>
        </http:response>
        <http:error-response statusCode="#[variables.httpStatus default 500]">
            <http:body>#[payload]</http:body>
            <http:headers>#[variables.outboundHeaders default {}]</http:headers>
        </http:error-response>
    </http:listener>
    <apikit:console config-ref="router-config" />
</flow>
----

You can also change the host, port, path, and scheme by editing the listener and listener-config.

== Configuring APIkit

In the HTTP Listener, you can configure a verbose form of the response HTTP headers and status code. APIkit has two new properties for this purpose:

* `outboundHeadersMapName`
+
Supports sending custom headers with the response.
+
*`httpStatusVarName`
+
Supports sending custom HTTP status code in the response.

=== Removal of Deprecated Properties

The following APIkit properties have been removed:

* `consolePath`
* `consoleEnabled`

== APIkit Project Structure

The API folder is located under resources. API definition files are no longer duplicated in the root folder.

```
|-- ProjectName
    `-- mule-application.json
    `-- pom.xml
    `-- src
        `-- main
            `-- mule
            |    `-- mule-config.xml
            `-- resources
                `-- api
                |    `-- api.raml
                `-- mule-artifact.properties
```

== Executing Non-functional Requirements after the Router

By defining any message processor, you can execute non-functional requirements or quality attributes after the Router. You can add logs or traceability for all flows in one place.

== Adding a Header to a Response

Put the header you want to add inside of the `outboundHeaders` map, as shown in the following example:

[source,xml,linenums]
----
<ee:transform>
    <ee:set-variables>
    <ee:set-variable name="outboundHeaders">
        variables.outboundHeaders ++{headerName:"value"}
    </ee:set-variable>
</ee:set-variables>
</ee:transform>
----

== Auto-generated Response (Enterprise Edition)

APIkit uses DataWeave for generating a mocked implementation based on the examples provided in a RAML definition.

== See Also

* link:/mule-user-guide/v/4.0/error-handling[Error Handling Reference]
* link:/apikit/apikit-simulate[To Simulate API Calls using API Console]
* https://github.com/raml-org/raml-spec/blob/master/versions/raml-10/raml-10.md/[RAML]
