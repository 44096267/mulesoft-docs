= What's New in APIkit

If you're an APIkit 3.x user, you'll notice that APIKit preserves its behavior in APIkit 4.x Beta, but this version includes changes and improvements:

* APIkit is now a Mule plugin 
+
* APIKit supports new API Console V4 and is no longer embedded in Anypoint Studio
+
* New APIKit configuration
+
* APIkit error handling is aligned with Mule 4.0.
+
* New project structure
+
* Other improvements and changes

== APIKit distribution

APIKit is a Mule Plugin, that can be updated in a straightforward manner. The timing of future improvements and fixes are no longer constrained by Studio or Mule release schedules.

In order to use APIKit, add the following dependency to the POM of your application.

[source,xml,linenums]
----
<dependency>
    <groupId>org.mule.modules</groupId>
    <artifactId>mule-apikit-module</artifactId>
    <version>version</version>
    <classifier>mule-plugin</classifier>
</dependency>
----

== New Error Handling

APIKit 4.0 replaces exception strategy and error mapping, with the Mule 4 error handler. This error handler uses error types:

[source,xml,linenums]
----
<apikit:router config-ref="api-config" />
<error-handler>
    <on-error-propagate type="APIKIT:BAD_REQUEST">
        <ee:transform xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd">
            <ee:message>
                <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{message: "Bad request"}]]></ee:set-payload>
            </ee:message>
            <ee:variables>
                <ee:set-variable variableName="httpStatus">400</ee:set-variable>
            </ee:variables>
        </ee:transform>
    </on-error-propagate>
</error-handler>    
----
Each error response is generated using DataWeave.

== New API Console

APIKit supports new API Console V4. It has several improvements, such as the ability to customize the url your request is heading up to.

=== Exposing API Console in your application

By default, the console is exposed in '/console'. Host, port, path and even scheme can be changed by editing its listener and listener-config.

[source,xml,linenums]
----
<flow name="main-console">
    <http:listener config-ref="httpListenerConfigDefault" path="/console/*">
        <http:response statusCode="#[variables.httpStatus default 200]">
            <http:headers>#[variables.outboundHeaders default {}]</http:headers>
        </http:response>
        <http:error-response statusCode="#[variables.httpStatus default 500]">
            <http:body>#[payload]</http:body>
            <http:headers>#[variables.outboundHeaders default {}]</http:headers>
        </http:error-response>
    </http:listener>
    <apikit:console config-ref="router-config" />
</flow>
----

== APIKit configuration

Mule 4 HTTP Listener has now a verbose way to specify the response HTTP headers and status code.
APIKit configuration has two new properties to explicitely define the mapping of this attributes

=== New properties added are:

`outboundHeadersMapName`

Supports sending custom headers with the response.

`httpStatusVarName`

Supports sending custom HTTP status code in the response.

=== Deprecated properties removed:

`consolePath`

`consoleEnabled`

== APIKit Project Structure

API folder is now under resources, and API definition files are no longer duplicated in the root folder.

```
|-- ProjectName
    `-- mule-application.json
    `-- pom.xml
    `-- src
        `-- main
            `-- mule
            |    `-- mule-config.xml
            `-- resources
                `-- api
                |    `-- api.raml
                `-- mule-artifact.properties
```

== Other improvements

=== Execute non-functional requirements after the Router

By defining any message processor, execute non-functional requirements or quality attributes after the Router. 
User can add logs or traceability for all flows in one place.

=== New way to add a Header to a Response

Put the header you want to add inside of the outboundHeaders map, as shown in the following example:

[source,xml,linenums]
----
<ee:transform>
    <ee:set-variables>
    <ee:set-variable name="outboundHeaders">
        variables.outboundHeaders ++{headerName:"value"}
    </ee:set-variable>
</ee:set-variables>
</ee:transform>
----

=== Responses consist of auto-generated Dataweave code. (Enterprise Edition)

APIkit uses DataWeave for generating a mocked implementation based on the examples provided in a RAML definition.

== See Also

* link:/mule-user-guide/v/4.0/error-handling[Error Handling Reference]
* link:/apikit/apikit-simulate[To Simulate API Calls using API Console]
* https://raml.org/[RAML]
