= Creating a Self-serviced VPC and Load Balacner

image:cloudhub-logo.png[cloudhub]

== Overview

This tutorial walks you through the creation of a *virtual private cloud* and a *dedicated load balancer* configuring firewall rules and mapping lists.

It also shows you how to create a simple application and deploy it to your new network environment.

== Prerequisites

This tutorial assumes that you purchased a link:/runtime-manager/virtual-private-cloud[VPC offering], and are familiar with the link:/runtime-manager/cloudhub-architecture[CloudHub architecture].

== Create a VPC

[tabs]
------
[tab,title="Anypoint Platform UI"]
....

In order to create a VPC, log in to your Anypoint Platform and follow these steps:

. Select the `VPCs` tab from the navigation bar to your left
. Click the Create VPC option
+
image::vpc-and-load-balancer-creation-df931.png[]
+
In the screen shown in the image below, you can start passing the parameters to define and configure your VPC:
+
image::vpc-and-load-balancer-creation-35c7d.png[]
+
. A VPC name. +
For this tutorial, name your VPC `vpc-tutorial`.
. The region to which the VPC is bound. +
In this case, we are bounding it to `US East`.
+
[NOTE]
--
All VPCs need to be associated to a CloudHub region.
--
+
. The size of your VPC in CIDR notation. +
We are setting it to 10.111.0.0/24 which grants us 256 IP addresses from 10.111.0.0 to 10.111.0.255.
+
[CAUTION]
--
It is not possible to resize a VPC once created. +
Understanding how to size your VPC is crucial at this point. If you are not sure how to configure this, make sure to follow our link:/runtime-manager/virtual-private-cloud#size-your-vpc[VPC sizing] guide
--
+
. Set an environment to which your VPC is bound. +
For this example, we are leaving the environment blank so every application deployed to US-EAST gets associated to this VPC disregarding to which environment it is being deployed. +
All VPCs need to also be bound to an link:/access-management/environments[environment] inside your CloudHub organization or business group. +
. Set wether this VPC is the default for the region you are creating it. +
In this case, we are setting it as default. This means that all environments in this region that are not associated to a VPC will be, by default, associated to this VPC.
. Set the business group to which your VPC is bound. +
By leaving it blank, you are associating this VPC to the main organization.
+
image::vpc-and-load-balancer-creation-97c25.png[]
+
. Set Firewall rules
. All outbound traffic is blocked by default. You need to create firewall rules to allow traffic to your VPC. +
The UI suggests us a list of most used firewall rules. For this example, we are adding a firewall rule with type 'http.private.port' from `Anywhere`. Note that the port range is automatically set to `8091`. +
+
This means that only connections through the port `8091` will be whitelisted inside the VPC. +
Your dedicated load balancer proxies external requests internally through port 8091. In order to proxy all requests from the load balancer, all applications that we deploy to the VPC must be listening http requests through port 8091.
. Click *Create VPC*.
....
[tab,title="Anypoint Platform CLI"]
....

This section shows you how to create the same VPC set up from the Runtime Manager UI, using the Anypoint Platform CLI.

In your environment, link:/runtime-manager/anypoint-platform-cli#logging-in[log in to your organization] and use the link:/runtime-manager/anypoint-platform-cli#cloudhub-vpc-create[vpc create] command to create the VPC:

[source,Example]
----
cloudhub vpc create vpc-tutorial us-east-1 10.111.0.0/24 --default
----

In this example:

. Our VPC is called `vpc-tutorial`
. Is bound to the `us-east-1` region
+
[NOTE]
--
All VPCs need to be associated to a CloudHub region.
--
+
. We are setting the size to `10.111.0.0/24`. In CIDR notation, this grants us 256 IP addresses from 10.111.0.0 to 10.111.0.255.
+
[CAUTION]
--
It is not possible to resize a VPC once created. +
Understanding how to size your VPC is crucial at this point. If you are not sure how to configure this, make sure to follow our link:/runtime-manager/virtual-private-cloud#size-your-vpc[VPC sizing] guide
--
+
. We are *not passing* any environment information. +
Not setting a specific environment makes that every application deployed to US-EAST gets associated to this VPC disregarding to which environment it is being deployed. +
All VPCs need to also be bound to an link:/access-management/environments[environment] inside your CloudHub organization or business group.
+
. We are setting it as default. This means that all environments in this region that are not associated to a VPC will be, by default, associated to this VPC. +
. We are *not passing* any business group information. +
By doing so, we are associating this VPC to the main organization.
+
When the operation succeeds, the CLI shows you the details of the newly created VPC.
+
Once the VPC is created, all outbound traffic is blocked by default. You need to create firewall rules to allow traffic to your VPC. +
In order to do so, you need to use the link:/runtime-manager/anypoint-platform-cli#cloudhub-vpc-firewall-rules-add[vpc firewall-rules add] command:
+
[source,Example]
----
cloudhub vpc firewall-rules add vpc-tutorial 0.0.0.0/0 tcp 8091
----
+
. We are allowing all traffic coming from the `http.private.port` (8091).
+
This means that only connections through the port `8091` will be whitelisted inside the VPC. +
Your dedicated load balancer proxies external requests internally through port 8091. In order to proxy all requests from the load balancer, all applications that we deploy to the VPC must be listening http requests through port 8091.

....
------

You just created a private and isolated network in the US-EAST region and allowed inbound traffic to it through port 8091.

=== Update an Existing VPC

Following the example above, assume you'd like to add an associated environment to `vpc-tutorial`. +

[tabs]
------
[tab,title="Anypoint Platform UI"]
....

. Find your VPC from the list of existing VPC in the UI, and select it.
. Navigate to the "Environments" dropdown menu and select the environment you'd like.
. Go to the bottom of the page and select "update VPC"

....
[tab,title="Anypoint Platform CLI"]
....
Although it is not possible to update certain values from your VPC through the Anypoint Platform CLI, you can use the link:https://anypoint.mulesoft.com/apiplatform/anypoint-platform/#/portals/organizations/68ef9520-24e9-4cf2-b2f5-620025690913/apis/8617/versions/85955/pages/107964[Cloudhub API]:

Log in to the CloudHub services passing your credentials through the `https://anypoint.mulesoft.com/accounts/login` endpoint.

Then, update your VPC using a `PUT` request to the `qa.anypoint.mulesoft.com/cloudhub/api/organizations/<yourOrganizationId>/vpcs/<yourVPCId>/` endpoint with a JSON payload:

[source,json,linenums]
----
{
	"associatedEnvironments": [
		"<EnvironmentId>"
	]
}
----

[NOTE]
--
`<EnvironmentId>` needs to be replaced by the Id of the environment to which you want to associate this VPC. +
You can get the Ids for your environments running a link:/runtime-manager/anypoint-platform-cli#account-environment-list[account environment list] command.
--

The same applies to update all other properties of your VPC. Follow the link:https://anypoint.mulesoft.com/apiplatform/anypoint-platform/#/portals/organizations/68ef9520-24e9-4cf2-b2f5-620025690913/apis/8617/versions/85955/pages/107964[Cloudhub API's portal documentation] to know how to update specific resources.
....
------

Now we are going to create a Load balancer inside this network, and configure it to be the exposed endpoint to reach your application.

== Create a Load Balancer

Once your VPC is created, you can set up a dedicated load balancer to administrate an SSL endpoint for the CloudHub workers deployed in your VPC. +
This feature will eventually be built into the Runtime Manager UI, however currently itâ€™s only available as a service that can be used via the link:/runtime-manager/anypoint-platform-cli[Anypoint Command Line Interface].

Each load balancer can be associated with one or more *SSL endpoints*. Such endpoints are identified by their certificate names. +
Certificates are an important component of your dedicated load balancer. When creating a load balancer, at least one SSL endpoint needs to be configured, meaning that each load balancer needs to have _at least_ one certificate associated to it. +
Understanding how to link:/runtime-manager/cloudhub-dedicated-load-balancer#managing-certificates[manage certificates], is therefore quite useful when managing dedicated load balancers.

In order to keep consistency with the examples provided in this tutorial, create a custom self-signed certificate for the domain `lb-tutorial-cert`. +

. In your terminal type, `cd` to your `Documents` folder:
+
[source,Example]
----
> cd /Users/myuser/Documents/
----
+
. Run an openssl request for a new self signed certificate, valid for 10 years:
+
[source,Example]
----
> openssl req -newkey rsa:2048 -new -nodes -x509 -days 3650 -keyout key.pem -out cert.pem
----
+
. After hitting return, you'll be prompted to complete a few details for your certificate.  +
As a guide, pass the following values:
+
[source,Example,linenums]
----
Country Name (2 letter code) [AU]: US
State or Province Name (full name) [Some-State]: California
Locality Name (eg, city) []:San Francisco
Organization Name (eg, company) [Internet Widgits Pty Ltd]:Mulesoft
Organizational Unit Name (eg, section) []: VPC Tutorial
Common Name (e.g. server FQDN or YOUR name) []: lb-tutorial-cert
Email Address []:max@mule.com
----

You created your certificate and private key pair, with a CNAME `lb-tutorial-cert`.

A load balancer can be created using the link:/runtime-manager/anypoint-platform-cli#cloudhub-load-balancer-create[load-balancer create] command:

[source,Example]
----
> cloudhub load-balancer create vpc-tutorial lb-tutorial /Users/myuser/Documents/cert.pem /Users/myuser/Documents/key.pem --http on --verificationMode on
----

. Pass `vpc-tutorial` as the vpc name in which you want to create the VPC.
. Name your load balancer `lb-tutorial`.
+
[NOTE]
--
The load balancer's name must be unique. +
Each load balancer has an internal domain name: `<lb-name>-internal.lb.anypointdns.net` where `<lb-name>` is the name you set here.
--
+
. Pass the path to a `.pem` file certificate and its key
+
[NOTE]
--
The certificate that you upload to your Load Balancer must be contained in one *_pem_ encoded* and *unencrypted* file. +
Your private key file needs to be *passphraseless*.
--
+
. Set the option for the http method to `on`. +
This sets the load balancer to accept all http requests and forwards it to your default SSL endpoint. In this case, the only ssl endpoint configured is `lb-tutorial-cert`
. Set the option for the verificationMode to `on` +
This instructs the SSL endpoint to always verify the certificate

Now that your VPC has a dedicated load balancer, create a link:/runtime-manager/cloudhub-dedicated-load-balancer#url-mapping[URL mapping list] to redirect traffic from your load balancer, to your specific application domain name:

[source,Example]
----
> cloudhub load-balancer mappings add lb-tutorial 0 /{app}/ {app} /
----

. Set `lb-tutorial` as the target for this new mapping rule
. Set the index priority for this mapping rule to 0 +
This rule now has the first priority.
. Set the input URL as `/{app}/` +
This rule uses patterns so that every value passed as `{app}` in your load balancer's domain name: `lb-tutorial-internal.lb.anypointdns.net/{app}` gets mapped to the URL set as the output URL.
. Set the output URL to `{app}` +
So that the domain `lb-tutorial-internal.lb.anypointdns.net/{app}` gets mapped to `{app}.cloudub.io/` using the pattern `{app}` to match your application's name.

Additionally, load balancers and VPCS can be programmatically managed using the link:/runtime-manager/runtime-manager-api[Cloudhub API] through the endpoints `anypoint.mulesoft.com/cloudhub/api/organizations/{orgid}/loadbalancers` and `anypoint.mulesoft.com/cloudhub/api/organizations/{orgid}/vpcs`.

== Delete a VPC

[NOTE]
--
In order to be able to delete a VPC, no load balancers need to be associated to it.

To delete a load balancer, use the link:/runtime-manager/anypoint-platform-cli#cloudhub-load-balancer-delete[load-balancer delete] command.
--
