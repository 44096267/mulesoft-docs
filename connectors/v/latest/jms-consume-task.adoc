:toc:               left
:toc-title:         JMS Connector
:toclevels:         2
:last-update-label!:
:docinfo:
:source-highlighter: coderay
:icons: font


= To Consume Messages with JMS

Messages can be consumed from message Queues or from Topics. The JMS Consume Operation and the JMS Listener Operation both allow you to consume messages from Queues or Topics.

The main difference between the JMS Listener and the JMS Consume operations is that the Listener operation triggers the new execution of a flow every time a message arrives, the Consume operation on the other hand, is not a trigger, so it checks for new messages only when activated by something else.

== Consume messages with a Listener Operation


. Create a Mule application as a project.

. Add a JMS Listener operation to your flow.

. Create a JMS configuration for the connection, leaving all of the fields with their default values.

. Set the Destination to the name of the queue you want to listen from.

. If you want to consume a Topic, change the Consumer Type to Topic.

== Consume messages with a Consume Operation


. Create a Mule application as a project.

. Add an HTTP Listener operation to your flow.

. Create an HTTP Configuration and leave all the default values. Set the HTTP Listener's path to `/getjms`

. Add a JMS Consume operation after the HTTP Listener in your flow.

. Create a JMS configuration for the connection, leaving all of the fields with their default values.

. Set the Destination to the name of the queue you want to listen from.

. If you want to consume a Topic, change the Consumer Type to Topic.


== Send an Acknowledgement

JMS sends an acknowledgement to the publisher of a message to confirm that the message was consumed. The JMS Consume and JMS Listener operations include an Ack Mode field that can be set to the following values:

* NONE (default): An acknowledgement is sent to the publisher of the message when the consuming operation finishes executing.

////
In the next release, NONE mode will be renamed to IMMEDIATE  (it's a lot less confusing like that)
////

* AUTO: An acknowledgement is sent to the publisher of the message when the entire flow finishes executing without any errors.

* DUPS_OK: Behaves like when set to AUTO, but duplicated Ack Ids are allowed.

* MANUAL: Lets you send an acknowledgement at a time of your choosing. You must add an Ack operation or a Recover Session operation on the point of your flow where you want acknowledgements to be sent.

See link:/connectors/v/latest/jms-manually-send-ack[To Manually Send a JMS Ack].


== Send a Response

When using the Listener Operation, you can send a reply to the publisher of the message. The publisher's address is taken from the `JMSReplyTo` header of the incoming message. Your response can include a Body, User Properties and JMSX Properties.



== Durable Subscriptions to Topics

[NOTE]
This option is only available when JMS 2.0 is used.

By default, when you subscribe a consumer to consume a topic, it only gets the messages that were posted after the moment when it became associated to that topic. If a subscription is set to be durable, then the consumer can consume all messages that were posted, including those posted before the consumer was associated.

To set a JMS Listener or Consume operation to be durable:

. Set Consumer Type to *Topic consumer*.

. Set Is Durable to *True*

Shared and Durable subscriptions can be combined, in which case both are bounded to the same subscription name.

== Shared Subscriptions to Topics

[NOTE]
This option is only available when JMS 2.0 is used.

A single JMS Listener or JMS Consume operation can contain multiple consumers, this allows you to improve performance of your message source. The more consumers you create in parallel for the same connection, the more throughput youâ€™ll get for dispatching events to your mule flow.

To avoid each of these consumers from processing the same messages in parallel, you can set the operation to share a subscription amongst its various consumers. When sharing a subscription, only one consumer handles each message, leaving the others idle to handle other messages. If you have multiple consumers and the subscription is not shared, then every message is processed multiple times, once by each consumer.


To set a JMS Listener or Consume operation to be shared by multiple consumers:

. Set Consumer Type to *Topic consumer*.

. Set Is Shared to *True*

. Set Number of Consumers to a number greater than 1

. Provide a name in Subscription Name. This field is required when using shared subscriptions.

Shared and Durable subscriptions can be combined, in which case both are bounded to the same subscription name.



== XML Example


The example below shows the simplest possible implementation of a JMS Listener. This example leaves several fields undefined and set as their default values.

[source,xml,linenums]
----
<jms:listener config-ref="config" destination="${destinationQueueName}"/>
----


To consume a message from a Topic (with either the Consumer or Listener operation), you must add a `consumer-type` structure with a `topic-consumer` child element in it:

[source,xml,linenums]
----
<jms:listener config-ref="config" destination="${incomingDestination}" ackMode="NONE" numberOfConsumers="1">
	<jms:consumer-type>
		<jms:topic-consumer subscriptionName="subName"/>
	</jms:consumer-type>
</jms:listener>
----

The table below describes other parameters for configuring the operation:

[%header,cols="30,70"]
|===
|Parameter |Description
|Destination | The name of the destination from which the messages are consumed.
|Maximum Wait | Sets the maximum time to wait for a message to arrive before failing with a TIMEOUT error.
|AckMode | NONE:
ACK occurs before the Message is dispatched to the next element in the Flow
AUTO:
ACK occurs when the processing of the entire flow is completed without errors
DUPS_OK:
Similar to AUTO but duplicated ACK are allowed
MANUAL:
Another operation needs to be added to send the ACK, it can be added on any part of the flow.
|Number of Consumers |
Defines how many consumers will be waiting for messages from the same topic.
|===


The example below includes a listener operation that includes 4 consumers that are subscribed to a topic with a shared subscription. When the processing of the flow is completed, a reply is sent with a message that's flagged as high priority.

[source,xml,linenums]
----
<jms:listener config-ref="config"  destination="topicListenerDestinationWithReply" numberOfConsumers="4">
   <jms:consumer-type>
	 		<jms:topic-consumer subscriptionName="demoSub" isShared="true"/>
   </jms:consumer-type>
   <jms:response priority="8" persistentDelivery="true">
       <jms:body>#[{ bridgedData: payload}]</jms:body>
   </jms:response>
</jms:listener>
----


== See Also

* link:/connectors/v/latest/jms-request-reply-task[To Do Request-Reply with JMS]

* link:/connectors/v/latest/jms-manually-send-ack[To Manually Send a JMS Ack]

* link:/connectors/v/latest/jms-about[About JMS Connector]

* link:/connectors/v/latest/jms-technical-ref[JMS Connector Technical Reference]
